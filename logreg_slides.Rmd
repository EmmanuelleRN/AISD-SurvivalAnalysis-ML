---
title: "~"
subtitle: " "
date: " "
output:
  xaringan::moon_reader:
    css: [default, my_css.css, metropolis-fonts]
    lib_dir: libs
    nature:
      ratio: '16:9'
      slideNumberFormat: '%current%'
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

class: class: center, middle, inverse


<!-- css: [default, duke-blue, hygge-duke] -->

```{r setup, echo=FALSE}
options(htmltools.dir.version = FALSE)
xaringanExtra::use_logo('www/channels4_profile-removebg-preview.png')
```

```{r include=FALSE}
library(dplyr)
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{css, echo = F}
.regression table {
  font-size: 12px;     
}

.dataTables_info{
  font-size: 10px;
}

.dataTables_paginate{
  font-size: 10px;
}

.dataTables_length{
  font-size: 10px;
}
```


# Survival Analysis

---

# Survival Analysis - Recapping

**Survival analysis** lets you analyze the rates of occurrence of events over time, without assuming the rates are constant. It lets you model:

- Time until an event occurs
- Compare the time-to-event between different groups
- Assess how time-to-event correlates with quantitative variables

For example:

- Time from surgery to death
- Time from start of treatment to cancer progression
- Time from HIV infection to development of AIDS
- Time to heart attack
- Time to onset of substance abuse
- Time to initiation of sexual activity
- Time to machine malfunction

---

# Definitions

The **hazard** is the instantaneous event (death) rate at a particular time point $t$. 
  - Survival analysis **doesn’t** assume the hazard is constant over time. 
  - The cumulative hazard is the total hazard experienced up to time $t$.

The **survival function**, is the probability an individual survives (or, the probability that the event of interest does not occur) up to and including time $t$. 
  - It’s the probability that the event hasn’t occurred yet. 

$$\mathbb{S}(t)=\mathbb{P}(T>t),$$
---

# Definitions - Kaplan-Meier 

where $T$ is the time of death

The **Kaplan-Meier** curve illustrates the survival function. 
- It estimates $\mathbb{S}(t)$
- It’s a step function illustrating the cumulative survival probability over time.

$$\hat{\mathbb{S}}(t) = \prod_{t_i<t}\left({1 - \frac{d_i}{n_i}}\right),$$

where $d_i$ is the number of subjects that died (or experienced the event of interest) at time $t_i$, and $n_i$ is the number of subjects at risk at time $t_i$.

At time 0, the survival probability is 1, i.e., $S(t_0) = 1$

---

# Definitions - Censoring

.pull-left[
**Censoring** is a type of missing data problem unique to survival analysis.
- It occurs when you track the sample/subject through the end of the study and the event never occurs, i.e., no event by end of fixed study period
- It could also happen due to the sample/subject dropping out of the study for reasons other than death, i.e., withdrawn from study
- It could also happen due to loss to followup,

If the sample is censored, you only know that the individual survived up to the loss to followup, but you do not know anything about survival after that.

Specifically these are examples of **right censoring**.

Left censoring and interval censoring are also possible, and methods exist to analyze this type of data, but this training will be limited to right censoring.]

.pull-right[

```{r swimmer, echo = FALSE}
library(tibble)
library(ggplot2)
# make fake data
set.seed(20180809)
fkdt <- tibble(Subject = as.factor(1:10), 
               Years = sample(4:20, 10, replace = T),
               censor = sample(c("Censor", rep("Event", 2)), 10, replace = T)) 

# plot with shapes to indicate censoring or event
ggplot(fkdt, aes(Subject, Years)) + 
    geom_bar(stat = "identity", width = 0.5) + 
    geom_point(data = fkdt, 
               aes(Subject, Years, color = censor, shape = censor), 
               size = 6) +
    coord_flip() +
    geom_hline(yintercept = 10) +
    geom_text(aes(0,  10,label = "end of study", vjust = 1, angle = 90, 
                  hjust = -.5)) +
    theme_minimal() + 
    theme(legend.title = element_blank(),
          legend.position = "bottom")
```

]

---

# Survival Analysis in R

Packages we will use for this example:

- **survival** 
  - The core functions for this type of analysis are available in this library
  - It is a part of the standard R packages, so you don't need to `install.packages()` before using it
- **dplyr**
  - Data manipulation
- **survminer**
  - Better visualization for Kaplan-Meier plots
  
For the example we will use the dataset `lung` that is available within the survival package.
  
```{r}
library(survival)
library(dplyr)
library(survminer)

head(lung, 3)
```

---

# Example - Lung

We can see the dimensions of the dataset by using the function `dim()` from base R. The first value represent the rows, in this example `r nrow(lung)` and the second represents the columns, `r ncol(lung)` in the example.

```{r}
dim(lung)
```
.pull-left[
The 10 columns represent:

- **inst:** Institution code
- **time:** Survival time in days
- **status:** censoring status 1 = censored, 2 = dead
- **age:** Age in years
- **sex:** Male = 1, Female = 2
- **ph.ecog:** ECOG performance (0 = good, 5 = dead)
- **ph.karno:** Karnofsky performance rated by physician
- **pat.karno:** Karnofsky performance rated by patient
- **meal.cal:** Calories consumed at meals
- **wt.loss:** Weight loss in last six months
]

.pull-right[
```{r}
glimpse(lung)
```

]
---

# Distribution of follow-up time

.pull-left[

- Censored subjects still provide information so must be appropriately included in the analysis
- Distribution of follow-up times is skewed, and may differ between censored patients and those with events
-Follow-up times are always positive

```{r echo = T, eval = FALSE}
ggplot(lung, aes(x = time, 
                 fill = as.factor(status))) +
  geom_histogram(bins = 25, 
                 alpha = 0.6, 
                 position = "identity") +
  scale_fill_manual(values = c("blue", "red"), 
                    labels = c("Censored", 
                               "Dead")) +
  labs(x = "Days",
       y = "Count")
```

]

.pull-right[

```{r echo=FALSE}
ggplot(lung, aes(x = time, fill = as.factor(status))) +
  geom_histogram(bins = 25, alpha = 0.6, position = "identity") +
  scale_fill_manual(values = c("blue", "red"), labels = c("Censored", "Dead")) +
  labs(x = "Days",
       y = "Count")
```

]

---

# Kaplan-Meier Analysis

The first thing to do is to use `Surv()` from `survival` to build the standard survival object. 

The most important parameters are:
- `time`: Follow-up time for right censored data; for interval data it represents the start time of the interval
- `event`: Normally 0 = alive, 1 = dead
- `time2`: Ending time of the interval for interval censored
- `type`: Type of censoring
  - Options: "right", "left", "counting", "interval", "interval2" or "mstate"
  - Default: "right"

> Note that a “+” after the time in the print out of km indicates censoring.

```{r}
km <- Surv(lung$time, lung$status)
head(km, 10)
```

---

# Kaplan-Meier Analysis

Now, let's fit a survival curve with the `survfit()` function. We will create a survival curve that doesn't consider any different groupings.
- We'll need to specify an intercept (represented by `~1` in the formula that survfit expects). 

We can 'model' the survival object `km` we created against an intercept
- We can do this in one step by nesting the `Surv()` function within `survfit()`
- Similarly to how we specify data for linear models with `lm()`, we'll use the `data =` argument to specify which data we’re using. 

```{r}
km_fit <- survfit(Surv(time, status) ~ 1, data = lung)
summary(km_fit, times = c(1, 30, 60, 90))
```

---

# Kaplan-Meier Plot

.pull-left[

- The `ggsurvplot` function from the `survminer` package is built on ggplot2, and can be used to create Kaplan-Meier plots.
- The default plot shows the step function (solid line) with associated confidence bands (shaded area).
- The tick marks representing censored patients are shown by default (can be suppressed using the option `censor = FALSE`)

]

.pull-right[
```{r}
ggsurvplot(km_fit)
```

]

---

# Estimating x-year survival

.pull-left[
Often of interest is the probability of surviving beyond a certain number ($x$) of years.

For example, to estimate the probability of surviving to $1$ year:
- Use `summary` with the `times` argument 
- *Note* the `time` variable in the `lung` data is actually in days

```{r}
summary(km_fit, times = 365)
```

The $1$-year probability of survival in this study is `r round(summary(km_fit, times = 365.25)$surv * 100, 2)`%. 

]

.pull-right[
```{r, message = FALSE, echo = FALSE, fig.height = 5}
plot_main <- 
  ggsurvplot(
    data = lung, 
    fit = km_fit,
    xlab = "Months",
    legend = "none",
    xscale = 30.4,
    break.x.by = 182.4, 
    risk.table = TRUE,
    risk.table.y.text = FALSE)
plot1 <- plot_main
plot1$plot <- plot1$plot + 
  geom_segment(x = 365, xend = 365, y = -0.05, yend = 0.4092416, 
               size = 1.5) +
  geom_segment(x = 365, xend = -40, y = 0.4092416, yend = 0.4092416,
               size = 1.5, 
               arrow = arrow(length = unit(0.2, "inches"))) 
plot1
```

---

# Estimating median survival time

.pull-left[

Another quantity often of interest is the **median survival time**.
- We can obtain this directly from the `survfit` object

```{r}
km_fit
```

We see the median survival time is `r round(summary(km_fit)$table["median"], 1)` days 
- The 95% confidence interval is also displayed.
]

.pull-right[

Median survival is the time corresponding to a survival probability of $0.5$: 

```{r, message = FALSE, echo = FALSE, fig.height = 5}
plot2 <- plot_main
plot2$plot <- plot2$plot + 
  geom_segment(x = -45, xend = 310, y = 0.5, yend = 0.5,  size = 1.5) +
  geom_segment(x = 310, xend = 310, y = 0.5, yend = -0.03, size = 1.5, 
               arrow = arrow(length = unit(0.2, "inches")))
plot2
```

]

---

# $x$-year survival and the survival curve

The $1$-year survival probability is the point on the y-axis that corresponds to $1$ year on the x-axis for the survival curve.

```{r, message = FALSE, echo = FALSE, fig.height = 5}
plot_main <- 
  ggsurvplot(
    data = lung, 
    fit = km_fit,
    xlab = "Months",
    legend = "none",
    xscale = 30.4,
    break.x.by = 182.4, 
    risk.table = TRUE,
    risk.table.y.text = FALSE)
plot1 <- plot_main
plot1$plot <- plot1$plot + 
  geom_segment(x = 365, xend = 365, y = -0.05, yend = 0.4092416, 
               size = 1.5) +
  geom_segment(x = 365, xend = -40, y = 0.4092416, yend = 0.4092416,
               size = 1.5, 
               arrow = arrow(length = unit(0.2, "inches"))) 
plot1
```
